# 5.프로듀서의 내부 동작 원리와 구현

* 프로듀서의 기본 역할

프로듀서 ====== send(메시지) =====> 카프카

```
send() {
  1. 시리얼라이저
  2. 파티셔너
}
```

## 5.1 파티셔너

파티셔너: 카프카 토픽의 어떤 파티션으로 메시지를 보낼지 결정. (기본적으로는 메시지의 키값을 이용해서 결정한다.)

*주의: 키값으로 파티션 결정시 파티션 수 증가시 다른 파티션에 메시지가 인입될 수 있으므로, 파티션 수는 변경하지 않는 것을 권장한다.

### 5.1.1 라운드 로빈 전략

메시지 키값이 null인 경우 라운드 로빈 전략이 선택된다.

파티셔너를 통해 어떤 파티션에 보내질지 결정된 메시지들은 버퍼 메모리 영역에서 잠시 대기한다.

이 때, 라운드 로빈일 경우 발생하는 비효율적인 모습이 있다.

1. 배치 전송을 위한 최소 레코드 수를 넘지 못하면 전송되지 않는다.
2. 시간 옵션을 조정하면 1번은 해결되지만, 배치와 압축의 효과를 얻지 못한채 메시지 하나만 전송되는 경우가 생긴다.

스티키 파티셔닝 전략이 보완한다.

### 5.1.2 스티키 파티셔닝 전략

카프카 2.4버전(2019)부터 사용하게 한 전략이다.

하나의 파티션에 레코드를 먼저 채우는 배치 전송 전략이다.

기본 설정에 비해 약 30%이상 지연 시간이 감소하고, 프로듀서의 CPU 사용율도 줄어들었다.

`???`카프카로 전송하는 메시지의 순서가 중요하지 않은 경우에 적용하기를 권장한다.

## 5.2 프로듀서의 배치

메시지를 한 개씩 전송하는 것이 아닌, 여러 개 모아서 전송한다.

프로듀서에서 처리량을 높이기 위해 배치 전송을 권장한다.

프로듀서의 버퍼 메모리에 영역에 토픽의 파티션 별로 메시지를 담아 놓는다.

- buffer.memory: 32MB, 메시지를 담아 놓는 버퍼 메모리의 용량이다.
- batch.size: 16KB, 배치 전송을 위해 메시지를 묶는 단위이다.
- linger.ms: 0ms, 버퍼 메모리에 메시지들이 대기하는 최대 시간이다.

배치 전송 장점
- 불필요한 I/O를 줄일 수 있다.(전송 요청 수 감소)

배치 전송 단점
- 배치 사이즈를 늘리면, 지연시간이 늘어난다.

*주의: buffer.memory > 토픽들의 파티션 수 * batch.size + 재시도 수행 메모리
