# 8. 카프카 버전 업그레이드와 확장

## 카프카 버전 업그레이드를 위한 준비

- 카프카의 현재 버전과 업그레이드 할 버전을 확인한다. (명령어, libs 확인)
- 메이저, 마이너, 패치 버전을 확인하면 어느 정도로 간단할 지 예상할 수 있다.
- 릴리스 노트를 꼭 확인한다.(https://kafka.apache.org/20/documentation/#upgrade_200_notable)
- 다운타임을 가질 수 있는지, 없는지 확인한다.(전체 종료 또는 롤링 업데이트)

## 롤링 업데이트

- 다운 타임을 갖는 전체 종료 업데이트를 할 수 없을 경우, 한 대씩 업그레이드 하는 롤링 업데이트를 이용한다.

1. 업그레이드 할 버전의 카프카를 준비한다.
2. `하위 버전 설정 파일 => 상위 버전 설정 파일`로 복사한다. (`/usr/local/kafka_2.12-2.1.0/config/server.properties => /usr/local/kafka_2.12-2.6.0/config/server.properties`)
3. 브로커 간의 내부 통신을 하위 버전으로 유지한다. 
   ```
   상위버전 server.properties 파일
   
   inter.broker.protocol.version=2.1 (내부 통신)
   log.message.format.version=2.1 (메시지 포맷)
   ```
4. 카프카 서버를 종료한다.
5. kafka 심볼릭 링크를 상위 버전으로 변경한다.
   ```
   /usr/local에서
   
   sudo systemctl stop kafka-server
   sudo rm -rf kafka
   sudo ln -sf kafka_2.12-2.6.0 kafka
   ll
   ```
6. 브로커를 실행한다.
7. 나머지 브로커들도 반복 작업 해준다.
8. 반복 작업이 끝난 후, `내부 통신과 메시지 포맷`을 업그레이드 해준다.(제거) & 재시작.

```
정리
1. 업그레이드 버전 카프카 준비
2. 설정파일준비 from 하위 to 상위 복사 & 내부통신 및 메시지 포맷 버전 
3. 브로커 종료
4. 심볼릭 링크삭제 및 상위로 생성
5. 브로커 시작
6. 롤링 끝난 후 내부통신 및 메시지 포맷 제거 & 재시작
```

팁.
1. 운영과 동일한 개발환경 카프카로 업그레이드를 수행해보기.
2. 사용량이 적은 시간에 업데이트 하기(리더 선출, 리더의 로그 세그먼트 일치 등등)

## 카프카 확장

- 카프카 확장에서 파티션의 분배는 수동으로 해주어야 한다.

1. 새로운 브로커를 추가한다. (고유 id)
2. `kafka-reassign-partitions.sh`을 이용해 토픽의 파티션을 분산시킨다.
3. 분산시킬 토픽에 대한 JSON 파일을 작성한다.
   ```
   {"topics":
      [{"topic":"토픽이름"}],
    "version":1
   }
   ```
4. 해당 파일과 sh을 이용해 재배치할 설정을 얻는다.
5. 재배치할 설정과 sh을 이용해 재배치 한다.

```
정리
1. 브로커 추가(고유id)
2. 분산시킬 토픽 JSON으로 재배치설정 JSON 얻기(kafka-reassgin-partition.sh이용)
3. 재배치하기(kafka-reassgin-partition.sh이용)
```

팁.
1. 리플리케이션이 일어나는 것이므로, 사용량 적은 시간에 확장한다.
2. 한 번에 하나의 토픽만 재배치 한다.
3. 토픽에서 불필요한 메시지는 지우고 재배치 한다.