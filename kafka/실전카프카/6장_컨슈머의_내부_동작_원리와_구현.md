# 6. 컨슈머의 내부 동작 원리와 구현

- 컨슈머 역할

![image](https://user-images.githubusercontent.com/54942017/182159047-a6174f26-3931-4520-b740-39c642020d24.png)

## 6.1 컨슈머 오프셋 관리

? 컨슈머가 재시작하거나 문제가 발생해 교체되었을 때 마지막으로 읽은 메시지 이후부터 읽기 위해 `위치를 기록` 하는데 `오프셋`이라 한다. => 다음으로 읽을 위치를 기록

=> 토픽에 저장한다.(`__consumer_offsets`) `컨슈머 그룹별`로 오프셋 정보가 기록됨.
=> 컨슈머 그룹, 토픽, 파티션에 대한 정보 등이 기록됨.

![image](https://user-images.githubusercontent.com/54942017/182162397-41f01c3d-d000-429b-b6a2-ed2d6f2cd93c.png)

브로커 설정파일 server.properties

- offsets.topic.num.partitions: 50
- offsets.topic.replication.factor: 3

## 6.2 그룹 코디네이터

? 운영을 하다보면 토픽의 파티션들이나 컨슈머 그룹의 컨슈머들에게 변화가 생길 수 있다. 이 때, 카프카는 컨슈머 리밸런싱을 통해 작업을 균등하게 분배하는데, 이 역할을 `그룹 코디네이터`가 한다.

- 그룹 코디네이터: 컨슈머 그룹의 토픽과 컨슈머들을 트래킹. => bootstrap.brokers의 브로커에게 초기 커넥션 요청시 생성됨.

- `컨슈머 그룹별 그룹 코디네이터`, `브로커 중 하나에 위치`

![image](https://user-images.githubusercontent.com/54942017/182185588-10e9527c-53c3-4eb0-807e-006deae82e9d.png)

---

### 컨슈머 그룹 등록 과정 with 그룹 코디네이터

1. bootstrap.brokers 리스트의 브로커에게 초기 커넥션 요청
2. 브로커는 그룹 코디네이터 생성 & 컨슈머에게 응답 / 코디네이터는 group.initial.rebalance.delay.ms 동안 대기
3. 컨슈머는 컨슈머 등록 요청을 함.(to 그룹 코디네이터). 가장 빨리 요청한 컨슈머 = 리더 컨슈머
4. 리더 컨슈머에 대한 등록 요청 응답으로 해당 그룹의 토픽 파티션 리스트 등을 보냄
5. 리더 컨슈머는 컨슈머 파티션 할당 전략에 따라 그룹내 컨슈머들에게 파티션 할당 후 그룹 코디네이터에게 정보 전달
6. 그룹 코디네이터는 해당 정보를 캐시하고, 컨슈머들에게 성공을 알림
7. 컨슈머들은 자신에게 할당된 파티션에서 메시지를 가져옴

---

### 컨슈머 등록(join), 탈퇴(leave), 장애(heartbeat)

장애시 처리는 heartbeat 체크를 통해서 이루어진다.
- heartbeat.interval.ms: 3000,
- session.timeout.ms: 10000,
- max.poll.interval.ms: 300000,

이 설정은 유지하는 것이 좋다.
- 빠르면 리밸런싱 자주
- 느리면 메시지 못 읽을 가능성

**주의. 리밸런싱은 비용이 매우 크다.**

---
