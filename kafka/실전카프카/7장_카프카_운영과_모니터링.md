# 7. 카프카 운영과 모니터링

## 안정적 운영을 위한 주키퍼와 카프카 구성

- 주키퍼 서버 수량: 3대(일반), 5대(중요)
- 주키퍼 하드웨어:
  - 높은 하드웨어 불필요. 
  - 메모리 4~8GB(일반적 힙메모리 사용 1~2GB)
  - 디스크 240G 또는 480G SSD(트랜잭션, 스냅샷 로그들을 로컬디스크에 저장)
  - 네트워크 카드 1G 이더넷(카프카와 메타데이터 정도만 주고 받음)
- 주키퍼 배치: 다른 랙에 분산 배치(물리 서버), 가용영역 분산(AWS)


- 카프카 서버 수량: 최소 3대(확장이 용이함)
- 카프카 하드웨어:
  - CPU사용량 높음, 코어수가 많은 CPU로 구성(배치, 압축기능의 압축, 해제에 많은 리소스 사용)
  - 메모리 32~256GB, JVM힙 6GB정도. 일반적 128, 256GB. 타이트하게 최소 32GB (힙 제외 나머지는 페이지 캐시로 사용됨)
  - 디스크 성능 불필요 SATA도 가능(로그 마지막에 순차적으로 쓰는 방식으로 로그 기록), 브로커 한 대당 병렬 처리를 위해 10개정도의 디스크, 4TB이상(토픽 주기 충분), NAS는 장애시 안좋음. EBS추천(AWS)
  - 네트워크 카드 10G 이더넷 카드(네트워크 사용량 비율 50% 안넘게)
- 카프카 배치: 다른 랙에 분산 배치(물리 서버), 전원 이중화, 스위치 이중화 등 고려. 가용영역 분산(AWS)

## 모니터링 시스템

- JMX, 프로메테우스, 익스포터, 그라파나
- 카프카 익스포터(컨슈머 LAG)


1. 지표들을 일단 수집한다.
2. 변화가 잦은 지표들에 임계치를 설정하고 알림을 받으며 모니터링 한다.
3. 최적화를 한다.